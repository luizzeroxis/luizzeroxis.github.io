<!doctype html>

<title>Audio player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<h1>Audio player</h1>

<div id="container">

	<div>File:</div>
	<div><input id='inputFile' type='file' accept='audio/*' /></div>

	<div>Speed:</div>
	<div><input id='inputSpeed' type='number' value=1 step=any></div>

	<div><button id='buttonPlay'>Play</button> <button id='buttonStop'>Stop</button></div>

</div>

<script>
	
	var $ = (q) => document.getElementById(q);

	var inputFile = $('inputFile');
	var inputSpeed = $('inputSpeed');
	var buttonPlay = $('buttonPlay');
	var buttonStop = $('buttonStop');

	var speed = 1;
	var file = null;

	var audioCtx = null;
	var source = null;

	inputFile.addEventListener('change', (e) => {

		file = e.target.files[0];
		if (source) {
			play();
		}

	});

	inputSpeed.addEventListener('change', (e) => {

		speed = e.target.value;
		if (source) {
			source.playbackRate.value = speed;
		}

	});

	buttonPlay.addEventListener('click', (e) => {
		play();
	});

	buttonStop.addEventListener('click', (e) => {
		stop();
	});

	var play = () => {

		if (!file) return;

		var fileReader = new FileReader();
		fileReader.onload = (e) => {

			// audioCtx.resume();
			if (source) {
				source.stop();
			}

			if (!audioCtx) audioCtx = new AudioContext();

			audioCtx.decodeAudioData(e.target.result)
			.then(buffer => {
				source = audioCtx.createBufferSource();
				source.buffer = buffer;
				source.playbackRate.value = speed;
				source.connect(audioCtx.destination);
			})
			.then(() => {
				source.start();
			});

		}
		fileReader.readAsArrayBuffer(file);
	}

	var stop = () => {
		if (source) {
			source.stop();
			source = null;
		}
	}
	
</script>